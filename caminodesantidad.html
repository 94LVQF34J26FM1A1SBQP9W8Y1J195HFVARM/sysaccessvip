//ACTIVIDAD
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPXP | Camino de Santidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Manrope', sans-serif; background-color: #f8fafc; }
        
        /* LOADER */
        #global-loader { position: fixed; inset: 0; background: white; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .spinner { width: 48px; height: 48px; border: 5px solid #e2e8f0; border-bottom-color: #4f46e5; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UTILIDADES VISUALES */
        .glass-login { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* TARJETAS */
        .card-elegant { transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid #e2e8f0; }
        .card-elegant:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #818cf8; }
        .card-closed { background-color: #f8fafc; opacity: 0.7; filter: grayscale(0.8); border-style: dashed; }

        /* HERO & GALLERY */
        .hero-section { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); position: relative; overflow: hidden; }
        .hero-pattern { background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 24px 24px; opacity: 0.1; position: absolute; inset: 0; }
        
        /* NAV BTN STYLE */
        .nav-btn {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 9999px;
            font-size: 0.85rem; font-weight: 600; color: #64748b;
            transition: all 0.2s ease;
        }
        .nav-btn:hover { background-color: #f1f5f9; color: #334155; }
        .nav-btn.active { background-color: #eef2ff; color: #4f46e5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .nav-btn svg { width: 18px; height: 18px; stroke-width: 2; }
        
        /* CORRECCIÓN CRÍTICA: Forzar ocultar nav-btn si tiene clase hidden */
        .nav-btn.hidden { display: none !important; }

        /* TICKET GRID */
        .ticket-box { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 800; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; user-select: none; }
        .t-free { background: #fff; border-color: #e2e8f0; color: #94a3b8; }
        .t-free:hover { border-color: #6366f1; color: #6366f1; background: #eef2ff; }
        .t-taken { background: #fffbeb; border-color: #f59e0b; color: #d97706; transform: scale(0.95); font-weight: 900; }
        .t-paid { background: #10b981; border-color: #059669; color: white; transform: scale(0.95); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .cursor-locked { cursor: default !important; opacity: 1; pointer-events: none; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-slate-50">

    <div id="global-loader">
        <div class="text-center">
            <span class="spinner mb-4"></span>
            <p class="font-bold text-slate-400 text-sm animate-pulse">Cargando Sistema...</p>
        </div>
    </div>

    <div id="view-login" class="hidden fixed inset-0 z-50 items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1438232992991-995b7058bbb3?auto=format&fit=crop&q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-indigo-950/80 backdrop-blur-sm"></div>
        <div class="glass-login w-[90%] max-w-md p-8 rounded-[2rem] shadow-2xl relative z-10 mx-auto fade-in flex flex-col items-center text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-full text-white mb-4 shadow-xl border-4 border-white">
                    <i class="fas fa-church text-3xl"></i>
                </div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tight uppercase">IPXP</h1>
                <p class="text-indigo-600 font-bold text-sm tracking-widest uppercase">Camino de Santidad</p>
            </div>
            <div id="login-guest-view" class="w-full space-y-6">
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                    <p class="text-slate-600 text-sm font-medium">Bienvenido. Seleccione una opción para ingresar.</p>
                </div>
                <button onclick="enterAsGuest()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-lg">
                    <span>INGRESAR COMO VISITANTE</span> <i class="fas fa-arrow-right"></i>
                </button>
                <div class="pt-4 border-t border-slate-200">
                    <button onclick="toggleLoginMode('admin')" class="text-xs font-bold text-slate-400 hover:text-indigo-600 transition-colors uppercase tracking-wider">
                        <i class="fas fa-lock mr-1"></i> Acceso Liderazgo
                    </button>
                </div>
            </div>
            <form id="login-form" class="hidden w-full space-y-4 animate-[fadeIn_0.3s_ease-out]">
                <div class="text-left">
                    <button type="button" onclick="toggleLoginMode('guest')" class="text-xs font-bold text-slate-400 hover:text-indigo-600 mb-4 flex items-center gap-1">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                    <h2 class="font-black text-lg text-slate-800 mb-2">Acceso Administrativo</h2>
                </div>
                <div><label class="text-[10px] font-black text-slate-500 uppercase ml-1">Correo</label><input type="email" id="email" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="admin@iglesia.com" required></div>
                <div><label class="text-[10px] font-black text-slate-500 uppercase ml-1">Contraseña</label><input type="password" id="password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="••••••" required></div>
                <button type="submit" id="btn-login" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><span>INICIAR SESIÓN</span></button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden flex-col h-full">
        
        <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 lg:px-8 shadow-sm shrink-0 z-30 sticky top-0 relative">
<div class="flex items-center gap-3 md:gap-4 w-auto md:w-1/4">
  <img src="https://iili.io/f00fJtf.png" alt="Logo IPXP" class="h-12 w-12 md:h-14 md:w-14 object-contain" />
  <div>
    <span class="font-extrabold text-lg tracking-tight text-slate-900 leading-none">IPXP<br>
      <span class="text-indigo-600 text-xs uppercase tracking-wider">Santidad</span>
    </span>
  </div>
</div>


            <div class="flex-1 flex justify-center overflow-x-auto no-scrollbar mx-2">
                <div class="flex items-center gap-1 md:gap-2 bg-white md:bg-transparent">
                    
                    <button onclick="switchTab('home')" id="nav-home" class="nav-btn active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        <span class="hidden md:inline">Inicio</span>
                    </button>

                    <button onclick="switchTab('news')" id="nav-news" class="nav-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        <span class="hidden md:inline">Anuncios</span>
                    </button>

                    <button onclick="switchTab('activities')" id="nav-activities" class="nav-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="hidden md:inline">Actividades</span>
                    </button>

                    <button onclick="switchTab('finance')" id="nav-finance" class="nav-btn hidden text-indigo-600">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        <span class="hidden md:inline">Finanzas</span>
                    </button>

                </div>
            </div>

            <div class="flex items-center justify-end gap-3 w-auto md:w-1/4">
                <div id="online-panel" class="hidden lg:flex items-center gap-2 px-3 py-1 bg-slate-50 rounded-full border border-slate-100">
                    <div id="avatars-container" class="flex -space-x-2"></div>
                </div>
                <div id="user-badge" class="hidden md:block"></div>
                <button onclick="logout()" class="w-9 h-9 rounded-xl bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                    <i class="fas fa-power-off text-sm"></i>
                </button>
            </div>
        </nav>

        <main id="main-content" class="flex-1 overflow-hidden relative bg-white">
            
            <section id="tab-home" class="tab-view h-full overflow-y-auto fade-in scroll-smooth">
                <div class="hero-section w-full py-20 px-6 lg:px-12 flex flex-col items-center justify-center text-center shadow-lg relative min-h-[60vh]">
                    <div class="hero-pattern"></div>
                    <div class="relative z-10 max-w-4xl mx-auto">
                        <span class="bg-white/10 backdrop-blur-sm text-indigo-100 border border-white/20 px-5 py-2 rounded-full text-xs font-bold uppercase tracking-widest mb-8 inline-block shadow-lg">Bienvenidos</span>
                        <h1 class="text-4xl md:text-7xl font-black text-white mb-6 leading-tight tracking-tight drop-shadow-sm">IPXP Camino de Santidad</h1>
                        <p class="text-indigo-100/90 text-lg md:text-xl font-medium max-w-2xl mx-auto leading-relaxed">
                            "Lámpara es a mis pies tu palabra, y lumbrera a mi camino." <br>
                            <span class="text-sm opacity-75 mt-2 block font-normal">Salmos 119:105</span>
                        </p>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-16 bg-white rounded-t-[50%] scale-110 translate-y-8"></div>
                </div>

                <div class="w-full bg-white py-16 px-6 lg:px-12">
                    <div class="max-w-5xl mx-auto">
                        <div class="text-center mb-12">
                            <h2 class="text-3xl font-black text-slate-900 tracking-tight">Horarios de Cultos</h2>
                            <p class="text-slate-500 font-medium mt-2">Te esperamos para adorar juntos.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            
                            <div class="p-6 rounded-2xl bg-indigo-50 border border-indigo-100 text-center hover:shadow-lg transition-all duration-300">
                                <div class="w-12 h-12 mx-auto bg-indigo-600 text-white rounded-full flex items-center justify-center mb-4 text-xl shadow-md"><i class="fas fa-praying-hands"></i></div>
                                <h3 class="font-black text-xl text-slate-800 mb-1">Oración</h3>
                                <p class="text-indigo-600 font-bold text-[10px] uppercase tracking-widest mb-3 bg-indigo-100 inline-block px-2 py-1 rounded">Martes</p>
                                <p class="text-slate-700 font-bold text-lg">07:30 PM</p>
                            </div>

                            <div class="p-8 rounded-[2rem] bg-slate-900 text-white text-center shadow-2xl transform md:-translate-y-4 relative overflow-hidden group">
                                <div class="absolute inset-0 bg-gradient-to-b from-indigo-900 to-slate-900 opacity-50"></div>
                                <div class="relative z-10">
                                    <div class="w-16 h-16 mx-auto bg-white text-slate-900 rounded-full flex items-center justify-center mb-6 text-2xl shadow-lg group-hover:scale-110 transition-transform"><i class="fas fa-church"></i></div>
                                    <h3 class="font-black text-2xl mb-2 tracking-tight">Culto Dominical</h3>
                                    <div class="mb-4"><span class="bg-indigo-600/30 border border-indigo-500/50 text-indigo-100 font-bold text-xs uppercase tracking-widest px-3 py-1 rounded-full">Domingo</span></div>
                                    <div class="space-y-1">
                                        <p class="text-white font-black text-4xl">10:00 AM</p>
                                        <p class="text-slate-400 font-bold text-sm uppercase">y 06:00 PM</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-6 rounded-2xl bg-indigo-50 border border-indigo-100 text-center hover:shadow-lg transition-all duration-300">
                                <div class="w-12 h-12 mx-auto bg-indigo-600 text-white rounded-full flex items-center justify-center mb-4 text-xl shadow-md"><i class="fas fa-book-open"></i></div>
                                <h3 class="font-black text-xl text-slate-800 mb-1">Enseñanza</h3>
                                <p class="text-indigo-600 font-bold text-[10px] uppercase tracking-widest mb-3 bg-indigo-100 inline-block px-2 py-1 rounded">Jueves</p>
                                <p class="text-slate-700 font-bold text-lg">07:30 PM</p>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 py-12 text-center border-t border-slate-800">
                    <div class="max-w-4xl mx-auto px-6">
                        <div class="flex flex-wrap justify-center gap-4 md:gap-8 text-slate-500 text-xs md:text-sm font-black uppercase tracking-[0.2em] leading-loose">
                            <span class="hover:text-white transition-colors cursor-default">Sola Misión</span>
                            <span class="text-indigo-600">•</span>
                            <span class="hover:text-white transition-colors cursor-default">Sola Fe</span>
                            <span class="text-indigo-600">•</span>
                            <span class="hover:text-white transition-colors cursor-default">Sola Gracia</span>
                            <span class="text-indigo-600">•</span>
                            <span class="hover:text-white transition-colors cursor-default">Soli deo Gloria</span>
                        </div>
                        <p class="text-slate-700 text-[10px] font-bold uppercase tracking-widest mt-8">© 2025 IPXP Camino de Santidad</p>
                    </div>
                </div>
            </section>

            <section id="tab-news" class="tab-view h-full overflow-y-auto hidden fade-in bg-slate-50">
                <div class="max-w-5xl mx-auto py-10 px-6">
                    <div class="flex justify-between items-center mb-8">
                        <div><h2 class="text-3xl font-black text-slate-900 tracking-tight">Anuncios</h2><p class="text-slate-500 text-sm font-medium">Información oficial de la iglesia.</p></div>
                        <button id="btn-add-news" onclick="addNews()" class="hidden bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> Publicar</button>
                    </div>
                    <div id="news-feed" class="grid grid-cols-1 gap-6"></div>
                </div>
            </section>

            <section id="tab-activities" class="tab-view h-full overflow-y-auto hidden fade-in bg-slate-50">
                <div class="max-w-7xl mx-auto py-10 px-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div class="text-center md:text-left"><h2 class="text-3xl font-black text-slate-900 tracking-tight">Actividades</h2><p class="text-slate-500 text-sm font-medium">Eventos pro-fondos y ministeriales.</p></div>
                        <div class="flex w-full md:w-auto items-center gap-3">
                            <div class="relative flex-1 md:w-72">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="search-input" onkeyup="filterActivities()" placeholder="Buscar actividad..." class="w-full bg-white border border-slate-200 rounded-xl py-2.5 pl-10 pr-4 font-bold text-sm outline-none focus:border-indigo-500 shadow-sm">
                            </div>
                            <button id="btn-new-act" onclick="openModal('modal-create')" class="hidden bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition-all whitespace-nowrap"><i class="fas fa-plus md:mr-2"></i> <span class="hidden md:inline">Crear</span></button>
                        </div>
                    </div>
                    <div id="activities-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 opacity-60">
                        <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-slate-400 text-2xl"><i class="fas fa-calendar-times"></i></div>
                        <p class="font-bold text-slate-500">No hay actividades recientes.</p>
                    </div>
                </div>
            </section>

            <section id="tab-finance" class="tab-view h-full overflow-y-auto hidden fade-in bg-slate-100">
                <div class="max-w-5xl mx-auto py-12 px-6">
                    <div class="mb-8 text-center">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-2 inline-block">Panel Liderazgo</span>
                        <h2 class="text-3xl font-black text-slate-900">Resumen Financiero</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-indigo-900 text-white p-8 rounded-[2rem] relative overflow-hidden shadow-xl">
                            <div class="relative z-10"><h3 class="text-indigo-200 font-bold text-xs uppercase tracking-wider mb-2">Total Recaudado (Global)</h3><p class="text-4xl font-black" id="dash-total">S/ 0.00</p><p class="text-indigo-300 text-xs mt-2 font-medium">Suma de tickets pagados.</p></div>
                            <i class="fas fa-chart-line absolute -bottom-6 -right-6 text-[8rem] text-indigo-800 opacity-50 rotate-12"></i>
                        </div>
                        <div class="bg-white p-8 rounded-[2rem] border border-slate-200 relative overflow-hidden shadow-lg">
                            <div class="relative z-10"><h3 class="text-slate-400 font-bold text-xs uppercase tracking-wider mb-2">Pendiente de Cobro</h3><p class="text-4xl font-black text-slate-800" id="dash-debt">S/ 0.00</p><p class="text-slate-400 text-xs mt-2 font-medium">Tickets entregados sin pagar.</p></div>
                            <i class="fas fa-hand-holding-usd absolute -bottom-6 -right-6 text-[8rem] text-slate-50 rotate-12"></i>
                        </div>
                    </div>
                </div>
            </section>

        </main>
        
        <div id="view-activity" class="hidden absolute inset-0 z-40 bg-white flex flex-col h-full fade-in">
             <header class="bg-white border-b border-slate-200 px-6 py-4 shadow-sm shrink-0 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button onclick="closeActDetail()" class="w-10 h-10 rounded-full bg-slate-50 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 flex items-center justify-center transition-colors border border-slate-200"><i class="fas fa-arrow-left"></i></button>
                    <div>
                        <div class="flex items-center gap-2">
                            <span id="act-category-badge" class="text-[10px] uppercase font-black bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded tracking-wider border border-indigo-100">CAT</span>
                            <div id="act-status-badge" class="hidden text-[10px] uppercase font-black bg-red-100 text-red-600 px-2 py-0.5 rounded border border-red-200">FINALIZADO</div>
                        </div>
                        <h2 id="act-title-header" class="text-xl font-black text-slate-900 leading-tight mt-1">Nombre Actividad</h2>
                    </div>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                     <button id="btn-toggle-status" onclick="toggleActivityStatus()" class="hidden px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-wider transition-colors border"></button>
                    <div id="header-stats" class="text-xs font-bold flex gap-3 items-center bg-slate-50 px-3 py-2 rounded-xl border border-slate-100"></div>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto bg-slate-50 p-6">
                <div class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="xl:col-span-2 space-y-6">
                        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-2xl border border-slate-200 shadow-sm sticky top-0 z-10 gap-4">
                            <span class="font-bold text-slate-800 flex items-center gap-2"><div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center"><i class="fas fa-ticket-alt"></i></div> Control de Tickets</span>
                            <div class="flex gap-2 w-full md:w-auto">
                                <div class="relative flex-1 md:w-64"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i><input type="text" id="search-dist" onkeyup="filterDistributors()" placeholder="Buscar..." class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 pl-9 pr-3 text-xs font-bold outline-none focus:border-indigo-500"></div>
                                <button id="btn-add-dist" onclick="openModal('modal-distributor')" class="hidden bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-indigo-700 active:scale-95 whitespace-nowrap transition-colors"><i class="fas fa-user-plus md:mr-1"></i> <span class="hidden md:inline">Asignar</span></button>
                            </div>
                        </div>
                        <div id="distributors-list" class="grid grid-cols-1 md:grid-cols-2 gap-5 pb-10"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-receipt text-orange-500"></i> Gastos Operativos</h3>
                            <form id="form-expense" class="hidden flex gap-2 mb-4">
                                <input type="text" id="exp-name" placeholder="Item" required class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:border-indigo-500">
                                <input type="number" step="0.5" id="exp-price" placeholder="S/" required class="w-20 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:border-indigo-500">
                                <button type="submit" class="bg-slate-900 text-white rounded-lg w-10 flex items-center justify-center hover:bg-slate-700"><i class="fas fa-plus"></i></button>
                            </form>
                            <div id="expenses-list" class="space-y-3 max-h-60 overflow-y-auto pr-1"></div>
                            <div class="border-t border-slate-100 mt-4 pt-3 flex justify-between items-center"><span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Gastos</span><span id="total-expenses-display" class="text-lg font-black text-slate-800">S/ 0.00</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="shareReport()" class="col-span-2 bg-[#25D366] text-white py-4 rounded-xl font-bold shadow-md hover:bg-[#20bd5a] flex items-center justify-center gap-2 active:scale-95 transition-all"><i class="fab fa-whatsapp text-2xl"></i> <span>Reporte</span></button>
                            <button id="btn-edit-act" onclick="openEditModal()" class="hidden col-span-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 flex items-center justify-center gap-2 transition-colors"><i class="fas fa-pen"></i> Editar</button>
                            <button id="btn-delete-act" onclick="deleteActivity()" class="hidden col-span-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 flex items-center justify-center gap-2 transition-colors"><i class="fas fa-trash"></i> Borrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-create" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-[90%] max-w-sm p-8 shadow-2xl animate-[zoomIn_0.2s_ease-out]">
            <h3 class="font-black text-xl mb-4 text-slate-800">Nueva Actividad</h3>
            <form id="form-create-activity" class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Categoría</label><input type="text" id="new-act-cat" list="cat-list" placeholder="Ej: Pro Templo..." required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"><datalist id="cat-list"></datalist></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Nombre Evento</label><input type="text" id="new-act-name" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Precio Ticket</label><input type="number" step="0.1" id="new-act-price" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div class="flex gap-3 pt-2"><button type="button" onclick="closeModal('modal-create')" class="flex-1 py-3 font-bold text-slate-400 hover:bg-slate-50 rounded-xl">Cancelar</button><button type="submit" class="flex-1 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">Crear</button></div>
            </form>
        </div>
    </div>
    <div id="modal-edit" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-[90%] max-w-sm p-8 shadow-2xl animate-[zoomIn_0.2s_ease-out]">
            <h3 class="font-black text-xl mb-4 text-slate-800">Editar Detalles</h3>
            <form id="form-edit-activity" class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Nombre Evento</label><input type="text" id="edit-act-name" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Precio Ticket</label><input type="number" step="0.1" id="edit-act-price" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div class="flex gap-3 pt-2"><button type="button" onclick="closeModal('modal-edit')" class="flex-1 py-3 font-bold text-slate-400 hover:bg-slate-50 rounded-xl">Cancelar</button><button type="submit" class="flex-1 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="modal-distributor" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-[90%] max-w-sm p-8 shadow-2xl animate-[zoomIn_0.2s_ease-out]">
            <h3 class="font-black text-xl mb-6 text-slate-800">Nuevo Responsable</h3>
            <form id="form-add-dist" class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Nombre Persona</label><input type="text" id="dist-name" required class="w-full p-4 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Cantidad de Tickets</label><input type="number" id="dist-qty" required class="w-full p-4 bg-slate-50 rounded-xl font-black text-lg text-indigo-900 border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                <div class="flex gap-3 pt-2"><button type="button" onclick="closeModal('modal-distributor')" class="flex-1 py-3 font-bold text-slate-400 hover:bg-slate-50 rounded-xl">Cancelar</button><button type="submit" class="flex-1 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">Asignar</button></div>
            </form>
        </div>
    </div>
    
    <div id="modal-news" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-[90%] max-w-sm p-8 shadow-2xl animate-[zoomIn_0.2s_ease-out]">
            <h3 class="font-black text-xl mb-4 text-slate-800">Publicar Anuncio</h3>
            <form id="form-news" class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Título</label>
                    <input type="text" id="news-title" placeholder="Ej: Culto de Jóvenes" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha y Hora</label>
                    <input type="datetime-local" id="news-date" required class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm text-slate-600 border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Imagen (Galería)</label>
                    <input type="file" id="news-file" accept="image/*" class="w-full p-2 bg-slate-50 rounded-xl font-bold text-xs border border-slate-200 text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">O Link de Imagen (Opcional)</label>
                    <input type="url" id="news-url" placeholder="https://..." class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Detalles</label>
                    <textarea id="news-desc" placeholder="Escribe los detalles aquí..." class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-200 h-20 resize-none outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('modal-news')" class="flex-1 py-3 font-bold text-slate-400 hover:bg-slate-50 rounded-xl">Cancelar</button>
                    <button type="submit" id="btn-save-news" class="flex-1 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all">Publicar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFcicNpYx_-zV9ZqhsmcofZKiN1UW-foc",
            authDomain: "data-client-2-d26da.firebaseapp.com",
            databaseURL: "https://data-client-2-d26da-default-rtdb.firebaseio.com",
            projectId: "data-client-2-d26da",
            storageBucket: "data-client-2-d26da.firebasestorage.app",
            messagingSenderId: "843725202694",
            appId: "1:843725202694:web:c98730835078b0e21a6a87",
            measurementId: "G-L5VJ6TY5KE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let allData = { activities: {}, news: {}, presence: {} };
        let currentActId = null;
        let currentUser = null; 
        let currentTab = 'home';
        let dataListenerActive = false;

        window.switchTab = (tabId) => {
            currentTab = tabId;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`nav-${tabId}`);
            if(btn) btn.classList.add('active');
            document.querySelectorAll('.tab-view').forEach(view => view.classList.add('hidden'));
            document.getElementById('view-activity').classList.add('hidden');
            const target = document.getElementById(`tab-${tabId}`);
            if(target) target.classList.remove('hidden');
        };

        window.closeActDetail = () => { currentActId = null; document.getElementById('view-activity').classList.add('hidden'); switchTab(currentTab); };
        window.toggleLoginMode = (mode) => { const g = document.getElementById('login-guest-view'), a = document.getElementById('login-form'); if(mode === 'admin'){ g.classList.add('hidden'); a.classList.remove('hidden'); } else { g.classList.remove('hidden'); a.classList.add('hidden'); } };

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>...</span>'; btn.disabled = true;
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(err => { Swal.fire('Error', 'Datos incorrectos', 'error'); btn.innerHTML = '<span>INICIAR SESIÓN</span>'; btn.disabled = false; });
        });

        // CORRECCION VISITANTE: Forzar inicio de listeners
        window.enterAsGuest = () => { 
            currentUser = { name: 'Visitante', isAdmin: false }; 
            initDataListeners(); 
            completeLogin(); 
        };

        window.logout = () => { if (auth.currentUser) remove(ref(db, `presence/${auth.currentUser.uid}`)); signOut(auth).then(() => location.reload()); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                let storedName = localStorage.getItem('adminName');
                if (!storedName) {
                    const { value: name } = await Swal.fire({ title: '¡Bienvenido Liderazgo!', input: 'text', allowOutsideClick: false });
                    storedName = name || 'Admin'; localStorage.setItem('adminName', storedName);
                }
                currentUser = { uid: user.uid, name: storedName, isAdmin: true };
                set(ref(db, `presence/${user.uid}`), { name: storedName, status: 'online' });
                onDisconnect(ref(db, `presence/${user.uid}`)).remove();
                initDataListeners();
                completeLogin();
            } else if(!currentUser) {
                document.getElementById('view-login').style.display = 'flex';
                document.getElementById('global-loader').style.display = 'none';
            }
        });

        function completeLogin() {
            document.getElementById('global-loader').style.display = 'none';
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            updateUI();
            switchTab('home');
        }

        function initDataListeners() {
            if(dataListenerActive) return; // Evitar duplicar listeners
            dataListenerActive = true;
            onValue(ref(db), (s) => {
                const val = s.val() || {};
                allData = { activities: val.activities || {}, news: val.news || {}, presence: val.presence || {} };
                refreshData();
                renderPresence();
                populateCategories();
                calcDashboard();
            });
        }

        function populateCategories() {
            const list = document.getElementById('cat-list'); list.innerHTML = '';
            const cats = new Set();
            Object.values(allData.activities).forEach(a => { if(a.category) cats.add(a.category); });
            cats.forEach(c => list.innerHTML += `<option value="${c}">`);
        }

        function calcDashboard() {
            if(!currentUser || !currentUser.isAdmin) return;
            let total = 0, debt = 0;
            Object.values(allData.activities).forEach(a => {
                const d = Object.values(a.distributors || {});
                d.forEach(x => { if(x.tickets) Object.values(x.tickets).forEach(s => { if(s === 'paid' || s === true) total += a.ticketPrice; if(s === 'taken') debt += a.ticketPrice; }); });
            });
            document.getElementById('dash-total').innerText = `S/ ${total.toFixed(2)}`;
            document.getElementById('dash-debt').innerText = `S/ ${debt.toFixed(2)}`;
        }

        function updateUI() {
            const badge = document.getElementById('user-badge');
            
            // LISTA DE SEGURIDAD (Elementos de Admin)
            const adminEls = [
                'btn-new-act',
                'btn-add-news',
                'btn-add-dist',
                'btn-delete-act',
                'btn-edit-act',
                'form-expense',
                'btn-toggle-status',
                'nav-finance' // <--- PROTEGIDO
            ];

            if (currentUser.isAdmin) {
                // --- MODO ADMIN ---
                badge.innerHTML = `<span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold border border-indigo-200"><i class="fas fa-shield-alt"></i> ${currentUser.name}</span>`;
                
                adminEls.forEach(id => { 
                    const el = document.getElementById(id); 
                    if(el) { 
                        el.classList.remove('hidden'); 
                        el.style.display = ''; // Limpiar estilos en línea
                        if(id === 'form-expense') el.classList.add('flex'); 
                    }
                });

            } else {
                // --- MODO VISITANTE ---
                badge.innerHTML = `<span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold"><i class="fas fa-eye"></i> Visitante</span>`;
                
                adminEls.forEach(id => { 
                    const el = document.getElementById(id); 
                    if(el) { 
                        el.classList.add('hidden'); 
                        el.style.display = 'none'; // FORZAR OCULTO (Importante)
                        if(id === 'form-expense') el.classList.remove('flex'); 
                    }
                });
                
                // SEGURIDAD: Si está en Finanzas, mandar a Inicio
                if(currentTab === 'finance') {
                    switchTab('home');
                }
            }
            refreshData();
        }

        function refreshData() {
            // News
            const nDiv = document.getElementById('news-feed'); 
            nDiv.innerHTML = '';
            const nList = Object.values(allData.news || {}).sort((a,b) => b.id - a.id);
            
            if(nList.length === 0) {
                nDiv.innerHTML = `<div class="text-center py-8 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl">
                    <i class="fas fa-newspaper text-3xl mb-2 opacity-50"></i><br>Sin anuncios por ahora.
                </div>`;
            }

            nList.forEach(n => {
                const del = currentUser.isAdmin ? `<button onclick="delNews('${n.id}')" class="absolute top-4 right-4 bg-white/80 p-2 rounded-full text-slate-400 hover:text-red-500 hover:bg-white shadow-sm transition-all z-10"><i class="fas fa-trash"></i></button>` : '';
                
                const dateObj = new Date(n.date);
                const dateStr = dateObj.toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });

                let imgHTML = '';
                if(n.image) {
                    imgHTML = `<div class="h-48 w-full bg-slate-200 mb-4 rounded-xl overflow-hidden relative">
                        <img src="${n.image}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-500">
                    </div>`;
                }

                nDiv.innerHTML += `
                    <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100 relative hover:shadow-xl transition-all duration-300 group">
                        ${del}
                        ${imgHTML}
                        <div class="mb-3">
                            <span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider border border-indigo-100">
                                <i class="far fa-clock mr-1"></i> ${dateStr}
                            </span>
                        </div>
                        <h3 class="text-xl font-black text-slate-800 mb-2 leading-tight">${n.title}</h3>
                        <p class="text-slate-600 text-sm leading-relaxed font-medium opacity-90">${n.desc}</p>
                    </div>`;
            });

            // Activities
            renderActivities();
            if(currentActId && allData.activities[currentActId]) renderDetail(currentActId);
        }

        window.filterActivities = () => renderActivities();

        function renderActivities() {
            const g = document.getElementById('activities-grid'); g.innerHTML = '';
            let l = Object.values(allData.activities).sort((a,b) => b.timestamp - a.timestamp);
            const search = document.getElementById('search-input').value.toLowerCase();
            if(search) l = l.filter(a => a.name.toLowerCase().includes(search));
            if(l.length === 0) document.getElementById('empty-state').classList.remove('hidden'); else document.getElementById('empty-state').classList.add('hidden');
            l.forEach(a => {
                const isClosed = a.status === 'closed';
                const statusBadge = isClosed ? '<span class="text-[9px] font-black uppercase text-red-600 bg-red-100 px-2 py-1 rounded-full tracking-wider border border-red-200">CERRADO</span>' : '<span class="text-[9px] font-black uppercase text-green-600 bg-green-100 px-2 py-1 rounded-full tracking-wider border border-green-200">ACTIVO</span>';
                const cardClass = isClosed ? 'card-closed' : 'bg-white card-elegant';
                const priceClass = isClosed ? 'text-slate-400' : 'text-indigo-600';
                g.innerHTML += `<div onclick="openAct('${a.id}')" class="${cardClass} p-6 rounded-2xl cursor-pointer group relative overflow-hidden shadow-sm"><div class="flex justify-between items-start mb-4"><span class="text-[10px] font-bold uppercase text-slate-500 bg-slate-100 px-2 py-1 rounded border border-slate-200">${a.category||'Gral'}</span>${statusBadge}</div><h3 class="font-black text-xl text-slate-800 mb-2 group-hover:text-indigo-600 transition-colors truncate">${a.name}</h3><div class="flex justify-between items-end mt-4"><p class="text-xs font-bold text-slate-400">${a.date}</p><p class="text-lg font-black ${priceClass}">S/ ${a.ticketPrice}</p></div></div>`;
            });
        }

        window.openAct = (id) => { currentActId = id; document.getElementById('view-activity').classList.remove('hidden'); renderDetail(id); }
        window.filterDistributors = () => { const term = document.getElementById('search-dist').value.toLowerCase(); document.querySelectorAll('.dist-card').forEach(c => { c.style.display = c.dataset.name.toLowerCase().includes(term) ? 'block' : 'none'; }); };

        function renderDetail(id) {
            const a = allData.activities[id];
            document.getElementById('act-title-header').innerText = a.name;
            document.getElementById('act-category-badge').innerText = a.category || 'EVENTO';
            const isClosed = a.status === 'closed';
            const btnStatus = document.getElementById('btn-toggle-status');
            if(isClosed) {
                document.getElementById('act-status-badge').classList.remove('hidden');
                btnStatus.innerHTML = '<i class="fas fa-undo-alt mr-2"></i> Reactivar';
                btnStatus.className = "hidden md:inline-flex items-center px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-wider bg-white text-slate-600 border border-slate-300 hover:bg-slate-50"; 
                if(currentUser.isAdmin) btnStatus.classList.remove('hidden');
            } else {
                document.getElementById('act-status-badge').classList.add('hidden');
                btnStatus.innerHTML = '<i class="fas fa-lock mr-2"></i> Finalizar';
                btnStatus.className = "hidden md:inline-flex items-center px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-wider bg-white text-red-500 border border-red-200 hover:bg-red-50";
                if(currentUser.isAdmin) btnStatus.classList.remove('hidden');
            }
            const d = Object.values(a.distributors || {}); const e = Object.values(a.expenses || {});
            let paidCount = 0, debtCount = 0, totalExpenses = 0;
            d.forEach(x => { if(x.tickets) Object.values(x.tickets).forEach(s => { if(s === 'paid' || s === true) paidCount++; if(s === 'taken') debtCount++; }); });
            e.forEach(x => totalExpenses += x.price);
            const totalIncome = paidCount * a.ticketPrice; const netProfit = totalIncome - totalExpenses;
            document.getElementById('header-stats').innerHTML = `<div class="flex flex-col items-end leading-none"><span class="text-[9px] text-slate-400 uppercase">Ingresos</span><span class="text-green-600">S/ ${totalIncome.toFixed(0)}</span></div><div class="w-px h-6 bg-slate-200 mx-1"></div><div class="flex flex-col items-end leading-none"><span class="text-[9px] text-slate-400 uppercase">Gastos</span><span class="text-red-500">S/ ${totalExpenses.toFixed(0)}</span></div><div class="w-px h-6 bg-slate-200 mx-1"></div><div class="flex flex-col items-end leading-none"><span class="text-[9px] text-slate-400 uppercase">Neto</span><span class="${netProfit>=0?'text-slate-800':'text-red-600'}">S/ ${netProfit.toFixed(1)}</span></div>`;
            const l = document.getElementById('distributors-list'); l.innerHTML = '';
            d.forEach(x => {
                let h = ''; const map = x.tickets || {};
                for (let i = x.start; i <= x.end; i++) {
                    let st = map[i], cls = 't-free'; if (st === 'taken') cls = 't-taken'; if (st === 'paid' || st === true) cls = 't-paid';
                    h += `<div ${currentUser.isAdmin?`onclick="ticketMenu('${x.id}',${i})"`:''} class="ticket-box ${cls} ${currentUser.isAdmin?'':'cursor-locked'}">${i}</div>`;
                }
                l.innerHTML += `<div class="dist-card bg-white p-5 rounded-2xl border border-slate-200 shadow-sm" data-name="${x.name}"><div class="flex justify-between items-center mb-3"><h4 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-user-circle text-slate-300"></i> ${x.name}</h4>${currentUser.isAdmin?`<button onclick="delDist('${x.id}','${x.name}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>`:''}</div><div class="grid grid-cols-5 gap-1.5 md:gap-2 md:grid-cols-10">${h}</div></div>`;
            });
            const el = document.getElementById('expenses-list'); el.innerHTML = '';
            if(e.length===0) el.innerHTML = '<p class="text-center text-xs text-slate-300 italic py-2">Sin gastos registrados</p>';
            e.forEach(x => { el.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100 text-xs hover:bg-white transition-colors group"><span class="font-bold text-slate-600">${x.name}</span><div class="flex gap-3 items-center"><span class="font-black text-slate-800">S/ ${x.price}</span>${currentUser.isAdmin?`<button onclick="delExp('${x.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-times"></i></button>`:''}</div></div>`; });
            document.getElementById('total-expenses-display').innerText = `S/ ${totalExpenses.toFixed(2)}`;
        }

        function renderPresence() {
            const c = document.getElementById('avatars-container'); c.innerHTML = '';
            const u = Object.values(allData.presence || {});
            document.getElementById('online-panel').classList.toggle('hidden', u.length === 0);
            u.forEach(x => c.innerHTML += `<div title="${x.name}" class="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-[10px] font-bold border-2 border-white relative cursor-help shadow-sm">${x.name.charAt(0)}</div>`);
        }

        const secureAction = (promise) => { if(!currentUser.isAdmin) return; promise.catch(() => Swal.fire('Error', 'Sin permiso.', 'error')); };
        const log = (t) => {};

        window.ticketMenu = async (did, n) => {
            const { isConfirmed, isDenied } = await Swal.fire({ title: `Ticket #${n}`, showDenyButton: true, showCancelButton: true, confirmButtonText: 'Cobrar', confirmButtonColor: '#10b981', denyButtonText: 'Fiado', denyButtonColor: '#f59e0b' });
            const path = `activities/${currentActId}/distributors/${did}/tickets/${n}`;
            if (isConfirmed) secureAction(set(ref(db, path), 'paid'));
            else if (isDenied) secureAction(set(ref(db, path), 'taken'));
            else if (Swal.getDismissReason() === Swal.DismissReason.cancel) secureAction(remove(ref(db, path)));
        };

        // Función auxiliar para leer archivo como Base64 (Texto)
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // Evento Submit de Noticias
        document.getElementById('form-news').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            
            // Efecto de carga en botón
            const btn = document.getElementById('btn-save-news');
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            btn.disabled = true;

            try {
                const id = Date.now(); 
                const fileInput = document.getElementById('news-file');
                const urlInput = document.getElementById('news-url');
                
                let finalImage = '';

                // Prioridad 1: Archivo subido
                if (fileInput.files.length > 0) {
                    finalImage = await toBase64(fileInput.files[0]);
                } 
                // Prioridad 2: URL escrita
                else if (urlInput.value.trim() !== '') {
                    finalImage = urlInput.value.trim();
                }

                await secureAction(set(ref(db, `news/${id}`), { 
                    id, 
                    title: document.getElementById('news-title').value, 
                    date: document.getElementById('news-date').value, 
                    desc: document.getElementById('news-desc').value,
                    image: finalImage
                }));

                closeModal('modal-news'); 
                document.getElementById('form-news').reset();

            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo subir la imagen (quizás es muy pesada)', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        document.getElementById('form-create-activity').addEventListener('submit', (e) => { e.preventDefault(); const id = Date.now(); secureAction(set(ref(db, 'activities/' + id), { id, name: document.getElementById('new-act-name').value, category: document.getElementById('new-act-cat').value, ticketPrice: parseFloat(document.getElementById('new-act-price').value), status: 'active', date: new Date().toLocaleDateString('es-PE'), timestamp: Date.now() }).then(() => { closeModal('modal-create'); e.target.reset(); })); });
        window.openEditModal = () => { const a = allData.activities[currentActId]; document.getElementById('edit-act-name').value = a.name; document.getElementById('edit-act-price').value = a.ticketPrice; openModal('modal-edit'); };
        document.getElementById('form-edit-activity').addEventListener('submit', (e) => { e.preventDefault(); secureAction(update(ref(db, `activities/${currentActId}`), { name: document.getElementById('edit-act-name').value, ticketPrice: parseFloat(document.getElementById('edit-act-price').value) }).then(() => { closeModal('modal-edit'); })); });
        window.toggleActivityStatus = () => { if(!currentActId || !currentUser.isAdmin) return; const a = allData.activities[currentActId]; const newStatus = (a.status === 'closed') ? 'active' : 'closed'; Swal.fire({ title: `¿${newStatus==='closed'?'Finalizar':'Reactivar'}?`, icon: 'question', showCancelButton: true }).then((result) => { if (result.isConfirmed) secureAction(update(ref(db, `activities/${currentActId}`), { status: newStatus })); }); };
        document.getElementById('form-add-dist').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('dist-name').value; const qty = parseInt(document.getElementById('dist-qty').value); if (!qty || qty <= 0) return Swal.fire('Error', 'Cantidad inválida', 'warning'); const ds = Object.values(allData.activities[currentActId].distributors || {}); let start = 1; if (ds.length > 0) start = Math.max(...ds.map(d => d.end)) + 1; const did = Date.now(); secureAction(set(ref(db, `activities/${currentActId}/distributors/${did}`), { id: did, name, start, end: start + qty - 1 }).then(() => { closeModal('modal-distributor'); document.getElementById('dist-name').value = ''; document.getElementById('dist-qty').value = ''; })); });
        window.addNews = () => { if(currentUser.isAdmin) openModal('modal-news'); };
        document.getElementById('form-expense').addEventListener('submit', (e) => { e.preventDefault(); const id=Date.now(); const n=document.getElementById('exp-name').value; secureAction(set(ref(db, `activities/${currentActId}/expenses/${id}`), { id, name: n, price: parseFloat(document.getElementById('exp-price').value) }).then(() => { document.getElementById('form-expense').reset(); })); });
        
        window.delDist = (id, n) => Swal.fire({title:`¿Borrar a ${n}?`,icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed)secureAction(remove(ref(db,`activities/${currentActId}/distributors/${id}`)));});
        window.delExp = (id) => secureAction(remove(ref(db, `activities/${currentActId}/expenses/${id}`)));
        window.delNews = (id) => secureAction(remove(ref(db, `news/${id}`)));
        window.deleteActivity = () => Swal.fire({title:'¿Borrar Evento?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed)secureAction(remove(ref(db,`activities/${currentActId}`)).then(()=>closeActDetail()));});
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.shareReport = () => { const a = allData.activities[currentActId]; const d = Object.values(a.distributors||{}); const e = Object.values(a.expenses||{}); let paid=0,debt=0,totalExp=0; d.forEach(x=>{if(x.tickets)Object.values(x.tickets).forEach(s=>{if(s==='paid'||s===true)paid++;if(s==='taken')debt++;});}); e.forEach(x=>totalExp+=x.price); const income=paid*a.ticketPrice; const profit=income-totalExp; const text=`*📊 REPORTE: ${a.name}*\n📅 ${a.date}\n${a.status==='closed'?'🔴 FINALIZADO':'🟢 ACTIVO'}\n\n💰 INGRESOS: S/ ${income.toFixed(2)} (${paid} tks)\n💸 GASTOS: S/ ${totalExp.toFixed(2)}\n-------------------------\n📈 NETO: S/ ${profit.toFixed(2)}\n-------------------------\n⚠️ Por Cobrar: S/ ${(debt*a.ticketPrice).toFixed(2)} (${debt} tks)`; window.open(`https://wa.me/?text=${encodeURIComponent(text)}`); };
    </script>
</body>
</html>